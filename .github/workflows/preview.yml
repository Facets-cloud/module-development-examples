name: Preview

on:
  push:
    paths:
      - '**/*.yaml'
      - '**/*.tf'

jobs:
  preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          ref: ${{ github.ref }}
          fetch-depth: 2  # Fetch the last two commits

      - name: Get Unique Changed Directories
        run: |
          set -e

          # Fetch changed files
          changed_files=$(git diff --name-only HEAD^ HEAD)

          # Get unique directories from changed files
          changed_dirs=$(echo "$changed_files" | xargs -n 1 dirname | sort -u)

          # Loop through the unique directories and check for facets.yaml
          echo "Unique changed directories:" 
          for dir in $changed_dirs; do
            echo "$dir"
            if [[ -f "$dir/facets.yaml" ]]; then
              # Register the module as preview
              curl -s https://facets-cloud.github.io/facets-schemas/scripts/module_register.sh | bash -s -- -c ${{ secrets.CONTROL_PLANE_URL }} -u ${{ secrets.USERNAME }} -t ${{ secrets.TOKEN }} -p "$dir"
            else
              echo "No facets.yaml found in $dir"
            fi
          done
